###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         10/Feb/2021  19:25:37 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ              #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\Sourc #
#                          e\SampleApp.c                                      #
#    Command line       =  -f "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ          #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\Tools\CC2530DB\f8wEndev.cfg"          #
#                          (-DCPU32MHZ -DROOT=__near_func                     #
#                          -DMAC_CFG_TX_DATA_MAX=3 -DMAC_CFG_TX_MAX=6         #
#                          -DMAC_CFG_RX_MAX=3) -f "E:\CC2530\CC2530-2019£¨ÖØÒ #
#                          ª£©45\µÚ5ÕÂ zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏß #
#                          Êý¾Ý´«Êä\ZStack-2.5.1a\Projects\zstack\Samples\Sam #
#                          pleApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig. #
#                          cfg" (-DZIGBEEPRO -DSECURE=0                       #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF1                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "E:\CC2530\CC2530-2019£¨ÖØÒ #
#                          ª£©45\µÚ5ÕÂ zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏß #
#                          Êý¾Ý´«Êä\ZStack-2.5.1a\Projects\zstack\Samples\Sam #
#                          pleApp\Source\SampleApp.c" -D NWK_AUTO_POLL -D     #
#                          ZTOOL_P1 -D MT_TASK -D MT_SYS_FUNC -D MT_ZDO_FUNC  #
#                          -D LCD_SUPPORTED=DEBUG -lC                         #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\EndDeviceEB\List\" -lA                         #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\EndDeviceEB\List\" --diag_suppress             #
#                          Pe001,Pa010 -o "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ #
#                          5ÕÂ zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä #
#                          \ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\C #
#                          C2530DB\EndDeviceEB\Obj\" -e --no_code_motion      #
#                          --debug --core=plain --dptr=16,1                   #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ          #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\" -I "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ    #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\Source\" -I "E:\CC2530\CC2530-2019£¨ÖØÒª£©4 #
#                          5\µÚ5ÕÂ zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý #
#                          ´«Êä\ZStack-2.5.1a\Projects\zstack\Samples\SampleA #
#                          pp\CC2530DB\..\..\..\ZMain\TI2530DB\" -I           #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\hal\include\" -I     #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\hal\target\CC2530EB\ #
#                          " -I "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ        #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\mac\include\" -I     #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\mac\high_level\" -I  #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\mac\low_level\srf04\ #
#                          " -I "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ        #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\mac\low_level\srf04\ #
#                          single_chip\" -I "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\ #
#                          µÚ5ÕÂ zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´« #
#                          Êä\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp #
#                          \CC2530DB\..\..\..\..\..\Components\mt\" -I        #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\osal\include\" -I    #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\services\saddr\" -I  #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\services\sdata\" -I  #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\stack\af\" -I        #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\stack\nwk\" -I       #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\stack\sapi\" -I      #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\stack\sec\" -I       #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\stack\sys\" -I       #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\stack\zdo\" -I       #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\zmac\" -I            #
#                          "E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ             #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\..\..\..\..\..\Components\zmac\f8w\" -Ohz      #
#                          --require_prototypes                               #
#    List file          =  E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ              #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\EndDeviceEB\List\SampleApp.lst                 #
#    Object file        =  E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ              #
#                          zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZSt #
#                          ack-2.5.1a\Projects\zstack\Samples\SampleApp\CC253 #
#                          0DB\EndDeviceEB\Obj\SampleApp.r51                  #
#                                                                             #
#                                                                             #
###############################################################################

E:\CC2530\CC2530-2019£¨ÖØÒª£©45\µÚ5ÕÂ zigbeeÐ­ÒéÕ»Ó¦ÓÃÓë×éÍø\3.¹ã²¥×éÍø-ÎÞÏßÊý¾Ý´«Êä\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\Source\SampleApp.c
      1          /**************************************************************************************************
      2            Filename:       SampleApp.c
      3            Revised:        $Date: 2009-03-18 15:56:27 -0700 (Wed, 18 Mar 2009) $
      4            Revision:       $Revision: 19453 $
      5          
      6            Description:    Sample Application (no Profile).
      7          
      8          
      9            Copyright 2007 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41            This application isn't intended to do anything useful, it is
     42            intended to be a simple example of an application's structure.
     43          
     44            This application sends it's messages either as broadcast or
     45            broadcast filtered group messages.  The other (more normal)
     46            message addressing is unicast.  Most of the other sample
     47            applications are written to support the unicast message model.
     48          
     49            Key control:
     50              SW1:  Sends a flash command to all devices in Group 1.
     51              SW2:  Adds/Removes (toggles) this device in and out
     52                    of Group 1.  This will enable and disable the
     53                    reception of the flash command.
     54          *********************************************************************/
     55          
     56          /*********************************************************************
     57           * INCLUDES
     58           */
     59          #include "OSAL.h"
     60          #include "ZGlobals.h"
     61          #include "AF.h"
     62          #include "aps_groups.h"
     63          #include "ZDApp.h"
     64          
     65          #include "SampleApp.h"
     66          #include "SampleAppHw.h"
     67          
     68          #include "OnBoard.h"
     69          
     70          /* HAL */
     71          #include "hal_lcd.h"
     72          #include "hal_led.h"
     73          #include "hal_key.h"
     74          #include "MT_UART.h"
     75          #include "MT_APP.h"
     76          #include "MT.h"
     77          
     78          /*********************************************************************
     79           * MACROS
     80           */
     81          
     82          /*********************************************************************
     83           * CONSTANTS
     84           */
     85          
     86          /*********************************************************************
     87           * TYPEDEFS
     88           */
     89          
     90          /*********************************************************************
     91           * GLOBAL VARIABLES
     92           */
     93          uint8 AppTitle[] = "ALD Broadcast"; //Ó¦ÓÃ³ÌÐòÃû³Æ
     94          
     95          // This list should be filled with Application specific Cluster IDs.
     96          const cId_t SampleApp_ClusterList[SAMPLEAPP_MAX_CLUSTERS] =
     97          {
     98            SAMPLEAPP_PERIODIC_CLUSTERID,
     99            SAMPLEAPP_FLASH_CLUSTERID
    100          };
    101          
    102          const SimpleDescriptionFormat_t SampleApp_SimpleDesc =
    103          {
    104            SAMPLEAPP_ENDPOINT,              //  int Endpoint;
    105            SAMPLEAPP_PROFID,                //  uint16 AppProfId[2];
    106            SAMPLEAPP_DEVICEID,              //  uint16 AppDeviceId[2];
    107            SAMPLEAPP_DEVICE_VERSION,        //  int   AppDevVer:4;
    108            SAMPLEAPP_FLAGS,                 //  int   AppFlags:4;
    109            SAMPLEAPP_MAX_CLUSTERS,          //  uint8  AppNumInClusters;
    110            (cId_t *)SampleApp_ClusterList,  //  uint8 *pAppInClusterList;
    111            SAMPLEAPP_MAX_CLUSTERS,          //  uint8  AppNumInClusters;
    112            (cId_t *)SampleApp_ClusterList   //  uint8 *pAppInClusterList;
    113          };
    114          
    115          // This is the Endpoint/Interface description.  It is defined here, but
    116          // filled-in in SampleApp_Init().  Another way to go would be to fill
    117          // in the structure here and make it a "const" (in code space).  The
    118          // way it's defined in this sample app it is define in RAM.
    119          endPointDesc_t SampleApp_epDesc;
    120          
    121          /*********************************************************************
    122           * EXTERNAL VARIABLES
    123           */
    124          
    125          /*********************************************************************
    126           * EXTERNAL FUNCTIONS
    127           */
    128          
    129          /*********************************************************************
    130           * LOCAL VARIABLES
    131           */
    132          uint8 SampleApp_TaskID;   // Task ID for internal task/event processing
    133                                    // This variable will be received when
    134                                    // SampleApp_Init() is called.
    135          devStates_t SampleApp_NwkState;
    136          
    137          uint8 SampleApp_TransID;  // This is the unique message ID (counter)
    138          
    139          afAddrType_t SampleApp_Periodic_DstAddr;
    140          afAddrType_t SampleApp_Flash_DstAddr;
    141          
    142          aps_Group_t SampleApp_Group;
    143          
    144          uint8 SampleAppPeriodicCounter = 0;
    145          uint8 SampleAppFlashCounter = 0;
    146          
    147          /*********************************************************************
    148           * LOCAL FUNCTIONS
    149           */
    150          void SampleApp_HandleKeys( uint8 shift, uint8 keys );
    151          void SampleApp_MessageMSGCB( afIncomingMSGPacket_t *pckt );
    152          void SampleApp_SendPeriodicMessage( void );
    153          void SampleApp_SendFlashMessage( uint16 flashTime );
    154          void SampleApp_SerialCMD(mtOSALSerialData_t *cmdMsg);
    155          
    156          /*********************************************************************
    157           * NETWORK LAYER CALLBACKS
    158           */
    159          
    160          /*********************************************************************
    161           * PUBLIC FUNCTIONS
    162           */
    163          
    164          /*********************************************************************
    165           * @fn      SampleApp_Init
    166           *
    167           * @brief   Initialization function for the Generic App Task.
    168           *          This is called during initialization and should contain
    169           *          any application specific initialization (ie. hardware
    170           *          initialization/setup, table initialization, power up
    171           *          notificaiton ... ).
    172           *
    173           * @param   task_id - the ID assigned by OSAL.  This ID should be
    174           *                    used to send messages and set timers.
    175           *
    176           * @return  none
    177           */
    178          void SampleApp_Init( uint8 task_id )
    179          { 
    180            SampleApp_TaskID = task_id;
    181            SampleApp_NwkState = DEV_INIT;
    182            SampleApp_TransID = 0;
    183            
    184            MT_UartInit();                  //´®¿Ú³õÊ¼»¯
    185            MT_UartRegisterTaskID(task_id); //×¢²á´®¿ÚÈÎÎñ
    186            HalUARTWrite(0,"UartInit OK\n", sizeof("UartInit OK\n"));//ÌáÊ¾ÐÅÏ¢
    187            
    188            // Device hardware initialization can be added here or in main() (Zmain.c).
    189            // If the hardware is application specific - add it here.
    190            // If the hardware is other parts of the device add it in main().
    191          
    192           #if defined ( BUILD_ALL_DEVICES )
    193            // The "Demo" target is setup to have BUILD_ALL_DEVICES and HOLD_AUTO_START
    194            // We are looking at a jumper (defined in SampleAppHw.c) to be jumpered
    195            // together - if they are - we will start up a coordinator. Otherwise,
    196            // the device will start as a router.
    197            if ( readCoordinatorJumper() )
    198              zgDeviceLogicalType = ZG_DEVICETYPE_COORDINATOR;
    199            else
    200              zgDeviceLogicalType = ZG_DEVICETYPE_ROUTER;
    201          #endif // BUILD_ALL_DEVICES
    202          
    203          #if defined ( HOLD_AUTO_START )
    204            // HOLD_AUTO_START is a compile option that will surpress ZDApp
    205            //  from starting the device and wait for the application to
    206            //  start the device.
    207            ZDOInitDevice(0);
    208          #endif
    209          
    210            // Setup for the periodic message's destination address
    211            // Broadcast to everyone
    212            SampleApp_Periodic_DstAddr.addrMode = (afAddrMode_t)AddrBroadcast;
    213            SampleApp_Periodic_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
    214            SampleApp_Periodic_DstAddr.addr.shortAddr = 0xFFFF;
    215          
    216            // Setup for the flash command's destination address - Group 1
    217            SampleApp_Flash_DstAddr.addrMode = (afAddrMode_t)afAddrGroup;
    218            SampleApp_Flash_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
    219            SampleApp_Flash_DstAddr.addr.shortAddr = SAMPLEAPP_FLASH_GROUP;
    220          
    221            // Fill out the endpoint description.
    222            SampleApp_epDesc.endPoint = SAMPLEAPP_ENDPOINT;
    223            SampleApp_epDesc.task_id = &SampleApp_TaskID;
    224            SampleApp_epDesc.simpleDesc
    225                      = (SimpleDescriptionFormat_t *)&SampleApp_SimpleDesc;
    226            SampleApp_epDesc.latencyReq = noLatencyReqs;
    227          
    228            // Register the endpoint description with the AF
    229            afRegister( &SampleApp_epDesc );
    230          
    231            // Register for all key events - This app will handle all key events
    232            RegisterForKeys( SampleApp_TaskID );
    233          
    234            // By default, all devices start out in Group 1
    235            SampleApp_Group.ID = 0x0001;
    236            osal_memcpy( SampleApp_Group.name, "Group 1", 7 );
    237            aps_AddGroup( SAMPLEAPP_ENDPOINT, &SampleApp_Group );
    238          
    239          #if defined ( LCD_SUPPORTED )
    240            HalLcdWriteString( "SampleApp", HAL_LCD_LINE_1 );
    241          #endif
    242          }
    243          
    244          /*********************************************************************
    245           * @fn      SampleApp_ProcessEvent
    246           *
    247           * @brief   Generic Application Task event processor.  This function
    248           *          is called to process all events for the task.  Events
    249           *          include timers, messages and any other user defined events.
    250           *
    251           * @param   task_id  - The OSAL assigned task ID.
    252           * @param   events - events to process.  This is a bit map and can
    253           *                   contain more than one event.
    254           *
    255           * @return  none
    256           */
    257          uint16 SampleApp_ProcessEvent( uint8 task_id, uint16 events )
    258          {
    259            afIncomingMSGPacket_t *MSGpkt;
    260            (void)task_id;  // Intentionally unreferenced parameter
    261          
    262            if ( events & SYS_EVENT_MSG )
    263            {
    264              MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SampleApp_TaskID );
    265              while ( MSGpkt )
    266              {
    267                switch ( MSGpkt->hdr.event )
    268                {        
    269                  // Received when a key is pressed
    270                  case KEY_CHANGE:
    271                    SampleApp_HandleKeys( ((keyChange_t *)MSGpkt)->state, ((keyChange_t *)MSGpkt)->keys );
    272                    break;
    273          
    274                  // Received when a messages is received (OTA) for this endpoint
    275                  case AF_INCOMING_MSG_CMD:
    276                    SampleApp_MessageMSGCB( MSGpkt );
    277                    break;
    278          
    279                  // Received whenever the device changes state in the network
    280                  case ZDO_STATE_CHANGE:
    281                    SampleApp_NwkState = (devStates_t)(MSGpkt->hdr.status);
    282                    if ( //(SampleApp_NwkState == DEV_ZB_COORD) ||
    283                           (SampleApp_NwkState == DEV_ROUTER)
    284                        || (SampleApp_NwkState == DEV_END_DEVICE) )
    285                    {
    286                      // Start sending the periodic message in a regular interval.
    287                      osal_start_timerEx( SampleApp_TaskID,
    288                                        SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
    289                                        SAMPLEAPP_SEND_PERIODIC_MSG_TIMEOUT );
    290                    }
    291                    else
    292                    {
    293                      // Device is no longer in the network
    294                    }
    295                    break;
    296          
    297                  default:
    298                    break;
    299                }
    300          
    301                // Release the memory
    302                osal_msg_deallocate( (uint8 *)MSGpkt );
    303          
    304                // Next - if one is available
    305                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SampleApp_TaskID );
    306              }
    307          
    308              // return unprocessed events
    309              return (events ^ SYS_EVENT_MSG);
    310            }
    311          
    312            // Send a message out - This event is generated by a timer
    313            //  (setup in SampleApp_Init()).
    314            if ( events & SAMPLEAPP_SEND_PERIODIC_MSG_EVT )
    315            {
    316              // Send the periodic message
    317              SampleApp_SendPeriodicMessage();
    318          
    319              // Setup to send message again in normal period (+ a little jitter)
    320              osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
    321                  (SAMPLEAPP_SEND_PERIODIC_MSG_TIMEOUT + (osal_rand() & 0x00FF)) );
    322          
    323              // return unprocessed events
    324              return (events ^ SAMPLEAPP_SEND_PERIODIC_MSG_EVT);
    325            }
    326          
    327            // Discard unknown events
    328            return 0;
    329          }
    330          
    331          /*********************************************************************
    332           * Event Generation Functions
    333           */
    334          /*********************************************************************
    335           * @fn      SampleApp_HandleKeys
    336           *
    337           * @brief   Handles all key events for this device.
    338           *
    339           * @param   shift - true if in shift/alt.
    340           * @param   keys - bit field for key events. Valid entries:
    341           *                 HAL_KEY_SW_2
    342           *                 HAL_KEY_SW_1
    343           *
    344           * @return  none
    345           */
    346          void SampleApp_HandleKeys( uint8 shift, uint8 keys )
    347          {
    348            (void)shift;  // Intentionally unreferenced parameter
    349            
    350            if ( keys & HAL_KEY_SW_1 )
    351            {
    352              /* This key sends the Flash Command is sent to Group 1.
    353               * This device will not receive the Flash Command from this
    354               * device (even if it belongs to group 1).
    355               */
    356              SampleApp_SendFlashMessage( SAMPLEAPP_FLASH_DURATION );
    357            }
    358          
    359            if ( keys & HAL_KEY_SW_2 )
    360            {
    361              /* The Flashr Command is sent to Group 1.
    362               * This key toggles this device in and out of group 1.
    363               * If this device doesn't belong to group 1, this application
    364               * will not receive the Flash command sent to group 1.
    365               */
    366              aps_Group_t *grp;
    367              grp = aps_FindGroup( SAMPLEAPP_ENDPOINT, SAMPLEAPP_FLASH_GROUP );
    368              if ( grp )
    369              {
    370                // Remove from the group
    371                aps_RemoveGroup( SAMPLEAPP_ENDPOINT, SAMPLEAPP_FLASH_GROUP );
    372              }
    373              else
    374              {
    375                // Add to the flash group
    376                aps_AddGroup( SAMPLEAPP_ENDPOINT, &SampleApp_Group );
    377              }
    378            }
    379          }
    380          
    381          /*********************************************************************
    382           * LOCAL FUNCTIONS
    383           */
    384          
    385          /*********************************************************************
    386           * @fn      SampleApp_MessageMSGCB
    387           *
    388           * @brief   Data message processor callback.  This function processes
    389           *          any incoming data - probably from other devices.  So, based
    390           *          on cluster ID, perform the intended action.
    391           *
    392           * @param   none
    393           *
    394           * @return  none
    395           */
    396          void SampleApp_MessageMSGCB( afIncomingMSGPacket_t *pkt ) //½ÓÊÕÊý¾Ý
    397          {
    398            uint16 flashTime;
    399          
    400            switch ( pkt->clusterId )
    401            {
    402              case SAMPLEAPP_PERIODIC_CLUSTERID:
    403                HalUARTWrite(0, "Rx:", 3);        //ÌáÊ¾ÐÅÏ¢
    404                HalUARTWrite(0, pkt->cmd.Data, pkt->cmd.DataLength); //Êä³ö½ÓÊÕµ½µÄÊý¾Ý
    405                HalUARTWrite(0, "\n", 1);         //»Ø³µ»»ÐÐ
    406                HalUARTWrite(0, "RSSI:", 5);        //ÌáÊ¾ÐÅÏ¢
    407                HalUARTWrite(0, (char)pkt->rssi,8); //Êä³ö½ÓÊÕµ½µÄÊý¾Ý
                                       ^
Error[Pe167]: argument of type "char" is incompatible with parameter of type
          "unsigned char *"
    408                break;
    409          
    410              case SAMPLEAPP_FLASH_CLUSTERID:     //´ËÊµÑéÃ»ÓÐÊ¹ÓÃ£¬µ½ºóÃæÊµÑéÏê½â
    411                flashTime = BUILD_UINT16(pkt->cmd.Data[1], pkt->cmd.Data[2] );
    412                HalLedBlink( HAL_LED_4, 4, 50, (flashTime / 4) );
    413                break;
    414            }
    415          }
    416          
    417          /*********************************************************************
    418           * @fn      SampleApp_SendPeriodicMessage
    419           *
    420           * @brief   Send the periodic message.
    421           *
    422           * @param   none
    423           *
    424           * @return  none
    425           */
    426          void SampleApp_SendPeriodicMessage( void )
    427          {
    428            uint8 data[11]="0123456789";
    429            if ( AF_DataRequest( &SampleApp_Periodic_DstAddr, &SampleApp_epDesc,
    430                                 SAMPLEAPP_PERIODIC_CLUSTERID,
    431                                 10,
    432                                 data,
    433                                 &SampleApp_TransID,
    434                                 AF_DISCV_ROUTE,
    435                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    436            {
    437            }
    438            else
    439            {
    440              // Error occurred in request to send.
    441            }
    442          }
    443          
    444          /*********************************************************************
    445           * @fn      SampleApp_SendFlashMessage
    446           *
    447           * @brief   Send the flash message to group 1.
    448           *
    449           * @param   flashTime - in milliseconds
    450           *
    451           * @return  none
    452           */
    453          void SampleApp_SendFlashMessage( uint16 flashTime )
    454          {
    455            uint8 buffer[3];
    456            buffer[0] = (uint8)(SampleAppFlashCounter++);
    457            buffer[1] = LO_UINT16( flashTime );
    458            buffer[2] = HI_UINT16( flashTime );
    459          
    460            if ( AF_DataRequest( &SampleApp_Flash_DstAddr, &SampleApp_epDesc,
    461                                 SAMPLEAPP_FLASH_CLUSTERID,
    462                                 3,
    463                                 buffer,
    464                                 &SampleApp_TransID,
    465                                 AF_DISCV_ROUTE,
    466                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    467            {
    468            }
    469            else
    470            {
    471              // Error occurred in request to send.
    472            }
    473          }
    474          /*********************************************************************
    475          *********************************************************************/

Errors: 1
Warnings: none
